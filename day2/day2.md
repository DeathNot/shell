# 1 构建基本脚本
## 1.5 重定向输入和输出
### 1.5.1 输出重定向
使用'>'可以将命令的输出发送到一个文件中，如果输出文件已经存在了，重定向操作符会用新的文件数据覆盖已有文件。使用'>>'可以不覆盖原始数据，而是在原始数据上追加数据。
### 1.5.2 输入重定向
输入重定向的符号为'<'。输入重定向的另一种方法称之为内联输入重定向，这种方法不需要使用文件进行重定向，只需要在命令行中指定用于输入重定向的数据即可。内联重定向符号为'<<'，除此之外，必须指定一个文本标记来划分输入数据的开始和结尾，任何字符串都可作为文本标记，但在数据的开始和结尾的文本标记必须一致。测试如下：
```
$ wc << EOF
> test string1
> test string2
> test string3
> EOF
 3  6 39
```
## 1.6 管道
使用'|'可以将一个命令的输出重定向到另一个命令中，使用形式如下：
```
command1 | command2
```
linux系统会同时运行这两个命令，在第一命令产生输出的同时，输出会被立即送给第二个命令。可以在一条命令中使用任意多条管道。
## 1.7 执行数学运算
在shell脚本中，有两种途径进行数学运算。
### 1.7.1 expr命令
expr命令允许在命令行上处理数学表达式，但是很笨拙。
```
$ expr 3 + 5 //操作数和运算符之间必须用空格隔开
8
```
expr能识别少量的数学和字符串操作符，具体如下：
```
a | b     //if (a != 0 && a != null) return a; else return b
a & b     //if((a != 0 && a != null) &&(b != 0 && b != null)) return a;else return 0
a < b     //return a < b ? 1 : 0
a <= b    //return a <= b ? 1 : 0
a = b     //return a = b ? 1 : 0
a != b     //return a != b ? 1 : 0
a >= b    //return a >= b ? 1 : 0
a > b    //return a > b ? 1 : 0
a + b     //return a+b
a - b     //return a-b
a * b     //return a*b
a / b     //return a/b
a % b     //return a%b
str1 : str2 // 如果str2匹配到str1中的某个模式，返回该模式匹配
match str1 str2   //如果str2匹配到str1中的某个模式，返回该模式匹配
substr str1 pos len //返回从pos开始（从１开始计数）的长度为len的子字符串
index str1 chars  //返回在str1中找到chars字符串的位置，找不到返回0
length str1　//返回字符串的数值长度
+ TOKEN   //将TOKEN解释为字符串，即使为关键字
(EXPRESSION)  //返回EXPRESSION的值
```
由于在命令行和shell脚本中，许多操作符另有含义，当他们在expr命令中出现时，需要用转义字符'\'将其标注，如下：
```
$ expr 5 * 2
expr: syntax error
$ expr 5 \* 2
10
```
在shell脚本中使用expr命令将一个算式的结果赋值给一个变量时，需要使用命令替换来获取其输出。
### 1.7.2 使用方括号
在bash中，将一个运算结果赋值给一个变量时，可以使用美元符和方括号将数学表达式围起来
```
$ var=$[1 + 5]
$ echo $var
6
$ var2=$[$var * 2]
$ echo $var2
12
```
在shell脚本中也可以使用这种方法，如下：
```
#!/bin/bash
var=100
var2=50
var3=45
var4=$[$var * ($var2 - $var3)]
echo the final result is $var4
```
在使用方括号时，不用担心shell会误解乘号或其他符号，在bash中，只支持整数运算，所以100/45=2。
### 1.7.3 浮点解决方案
最常用的解决方案是使用内建的bash计算器，叫做bc。
#### 1.bc的基本用法
bash计算器实际上是一种编程语言，它允许在命令行中输入浮点表达式，然后解析并计算该表达式，最终返回结果。bash计算器能够识别：数字（整数和浮点数）、变量（简单变量和数组）、注释（以#或/**/开始的行）、表达式、编程语句、函数。命令行中使用bc命令进入计算器，使用quit退出。

浮点运算由内建变量scale控制，scale默认为0，必须将这个值设置为你希望在计算结果中保留的小数位数，才能得到期望的结果。使用-q选项，可以去除bc的欢迎信息。可以使用print打印变量和数字。
#### 2.在脚本中使用bc
可以使用命令替换运行bc命令，并将输出赋给一个变量。基本格式为：
```
var=$(echo "options; expression" | bc)
```
第一部分允许你设置变量，多个变量使用';'分割。测试脚本如下：
```
#!/bin/bash
var=$(echo "scale=4; 3.25 / 2" | bc)
echo the result is $var
```
得到结果为
```
$ ./test2.sh
the result is 1.6250
```
如果需要大量运算，可使用内联输入重定向，测试程序如下：
```
#!/bin/bash
var1=10.46
var2=43.67
var3=33.2
var4=71

var5=$(bc << EOF
scale=4
a1 = ($var1 * $var2)
b1 = ($var3 * $var4)
a1 + b1
EOF
)

echo the result is $var5
```
## 1.8 退出脚本
shell中运行的每个命令都使用退出状态码，告诉shell他已经运行完毕，退出状态码是一个0-255的整数值，在命令结束时由命令传给shell，可以捕获这个值并在脚本中使用。
### 1.8.1 查看退出状态码
linux提供了一个专门的变量$?来查看退出状态码，对于需要进行检查的命令，必须在其运行完毕后立刻查看或使用$?变量。它的值会变成shell执行的最后一条命令的退出状态码。退出状态码如下表：
```
0     命令成功结束
1     一般性未知错误
2     不适合的shell命令
126   命令不可执行
127   没找到命令
128   无效的退出参数
128+x 与linux信号x相关的严重错误
130   通过Ctrl+C终止的命令
255   正常范围之外的退出状态码  
```
### 1.8.3 exit命令
在shell脚本中可以通过exit命令来改变默认行为，返回自己的退出状态码。使用方式为，在脚本结束时添加一条exit命令
```
exit num
```
exit的参数可以是具体的数值，也可以是变量，如果exit参数的值大于255，就会进行%255运算，得到退出状态码。
